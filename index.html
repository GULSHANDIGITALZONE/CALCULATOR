<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculator</title>
  
  <style>
    body {
      background: #f0f0f0;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .calculator {
      background: #222;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 380px;
    }

    .display {
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      word-wrap: break-word;
    }

    .input-line {
      font-size: 1.1em;
      color: #aaa;
      min-height: 22px;
    }

    .result-line {
      font-size: 1.8em;
      color: #0f0;
      min-height: 40px;
      text-align: right;
    }

    .buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    button {
      font-size: 1.05em;
      padding: 12px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.15s;
    }

    button:active { background: #555; }

    .equals { background: #0a0; }
    .clear { background: #a00; }
    .backspace { background: #c60; }

    .extra-functions { display: none; margin-top: 10px; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .extra-functions.show { display: grid; }

    .age-panel {
      display: none;
      margin-top: 10px;
      background: #111;
      padding: 10px;
      border-radius: 8px;
    }

    .age-panel.show { display: block; }

    .age-row { display:flex; gap:8px; margin-bottom:8px; }
    .age-row input {
      flex:1;
      padding:8px;
      border-radius:6px;
      border:1px solid #444;
      background:#222;
      color:#fff;
    }

    .history {
      margin-top: 12px;
      background: #111;
      color: #fff;
      padding: 10px;
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
      font-size: 0.9em;
    }

    .history-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 4px 0;
      padding: 6px;
      background: #222;
      border-radius: 5px;
    }

    .copy-btn {
      font-size: 0.8em;
      padding: 4px 6px;
      background: #555;
    }

    @media (max-width: 480px) {
      .input-line { font-size: 1em; }
      .result-line { font-size: 1.4em; }
      button { font-size: 0.95em; padding: 10px; }
      .extra-functions { grid-template-columns: repeat(2,1fr); }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loading-overlay">
    <div class="loader-content">
      <div class="spinner"></div>
      <div class="loading-text">Loading...</div>
    </div>
  </div>

  <style>
    #loading-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }
    .loader-content { text-align: center; font-family: "Segoe UI", sans-serif; }
    .spinner { width: 48px; height: 48px; border-radius: 50%; border: 5px solid rgba(0,0,0,0.08); border-top-color:#0073e6; animation: spin 1s linear infinite; margin:0 auto 8px; }
    .loading-text { font-size: 16px; color: #333; font-weight:600; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

  <script>
    window.addEventListener('load', function() {
      const overlay = document.getElementById('loading-overlay');
      overlay.style.opacity = '0';
      setTimeout(() => overlay.remove(), 300);
    });
  </script>
  
  <div class="calculator">
    <div class="display">
      <div id="inputLine" class="input-line"></div>
      <div id="resultLine" class="result-line">0</div>
    </div>

    <div class="buttons">
      <button onclick="press('7')">7</button>
      <button onclick="press('8')">8</button>
      <button onclick="press('9')">9</button>
      <button onclick="press('/')">Ã·</button>

      <button onclick="press('4')">4</button>
      <button onclick="press('5')">5</button>
      <button onclick="press('6')">6</button>
      <button onclick="press('*')">Ã—</button>

      <button onclick="press('1')">1</button>
      <button onclick="press('2')">2</button>
      <button onclick="press('3')">3</button>
      <button onclick="press('-')">âˆ’</button>

      <button onclick="press('0')">0</button>
      <button onclick="press('.')">.</button>
      <button onclick="calculate()" class="equals">=</button>
      <button onclick="press('+')">+</button>

      <button onclick="clearDisplay()" class="clear">C</button>
      <button onclick="backspace()" class="backspace">âŒ«</button>
      <button id="moreBtn" onclick="toggleExtra()">More</button>
      <button onclick="clearHistory()">Clear History</button>
    </div>

    <!-- Extra functions -->
    <div id="extra" class="buttons extra-functions">
      <button onclick="press('%')">%</button>
      <button onclick="square()">xÂ²</button>
      <button onclick="sqrt()">âˆšx</button>
      <!-- Age Calc button -->
      <button onclick="toggleAgePanel()" style="grid-column: span 2;">Age</button>
    </div>

    <!-- Age calculation panel (hidden until Age Calc clicked) -->
    <div id="agePanel" class="age-panel">
      <div style="color:#ddd;margin-bottom:6px;font-size:0.95em">Enter dates in <strong>DDMMYYYY</strong> format</div>
      <div class="age-row">
        <input id="date1" placeholder="From (DDMMYYYY)" maxlength="8" />
        <input id="date2" placeholder="To (DDMMYYYY)" maxlength="8" />
      </div>
      <div style="display:flex; gap:8px;">
        <button onclick="calcAgeFromInputs()">Calculate Age</button>
        <button onclick="fillToday('date2')">Use Today (To)</button>
        <button onclick="hideAgePanel()">Close</button>
      </div>
    </div>

    <div id="history" class="history"></div>
  </div>

  <script>
    let inputLine = document.getElementById("inputLine");
    let resultLine = document.getElementById("resultLine");
    let historyDiv = document.getElementById("history");
    let extraDiv = document.getElementById("extra");
    let moreBtn = document.getElementById("moreBtn");
    let agePanel = document.getElementById("agePanel");

    function isOperator(ch) {
      return ch === '+' || ch === '-' || ch === '*' || ch === '/' || ch === '%' ;
    }

    function press(value) {
      if (resultLine.innerText === "Error") {
        if (!isOperator(value)) {
          resultLine.innerText = value;
        } else {
          return;
        }
      } else if (resultLine.innerText === "0") {
        if (isOperator(value)) {
          if (value === '-') {
            resultLine.innerText = value;
          } else return;
        } else resultLine.innerText = value;
      } else {
        let last = resultLine.innerText.slice(-1);
        if (isOperator(last) && isOperator(value)) {
          resultLine.innerText = resultLine.innerText.slice(0, -1) + value;
        } else if (value === '.') {
          let parts = resultLine.innerText.split(/[\+\-\*\/%]/);
          let curr = parts[parts.length - 1];
          if (curr.includes('.')) return;
          else resultLine.innerText += value;
        } else {
          resultLine.innerText += value;
        }
      }
      inputLine.innerText = resultLine.innerText;
    }

    function sanitizeExpression(expr) {
      if (!expr) return "";
      expr = expr.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
      while (expr.length > 0 && /[+\-*/%.]$/.test(expr)) expr = expr.slice(0, -1);
      return expr;
    }

    function calculate() {
      try {
        let raw = resultLine.innerText;
        let expr = sanitizeExpression(raw);
        if (!expr) {
          resultLine.innerText = "0";
          inputLine.innerText = "";
          return;
        }
        let result = Function('"use strict";return (' + expr + ')')();
        if (result === Infinity || result === -Infinity || isNaN(result)) {
          resultLine.innerText = "Error";
        } else {
          inputLine.innerText = resultLine.innerText + " =";
          addHistory(resultLine.innerText + " = " + result);
          resultLine.innerText = (Number.isInteger(result) ? String(result) : String(result));
        }
      } catch (e) {
        resultLine.innerText = "Error";
      }
    }

    function clearDisplay() {
      inputLine.innerText = "";
      resultLine.innerText = "0";
    }

    function backspace() {
      if (resultLine.innerText.length > 1 && resultLine.innerText !== "Error") {
        resultLine.innerText = resultLine.innerText.slice(0, -1);
      } else {
        resultLine.innerText = "0";
      }
      inputLine.innerText = resultLine.innerText;
    }

    function toggleExtra() {
      extraDiv.classList.toggle("show");
      if (extraDiv.classList.contains("show")) moreBtn.innerText = "Less";
      else {
        moreBtn.innerText = "More";
        hideAgePanel(); // hide age panel when collapsing extras
      }
    }

    function square() {
      try {
        let val = sanitizeExpression(resultLine.innerText);
        if (!val) { resultLine.innerText = "Error"; return; }
        let num = Function('"use strict";return (' + val + ')')();
        let result = num * num;
        inputLine.innerText = num + "Â²";
        addHistory(inputLine.innerText + " = " + result);
        resultLine.innerText = result;
      } catch {
        resultLine.innerText = "Error";
      }
    }

    function sqrt() {
      try {
        let val = sanitizeExpression(resultLine.innerText);
        if (!val) { resultLine.innerText = "Error"; return; }
        let num = Function('"use strict";return (' + val + ')')();
        if (num < 0) { resultLine.innerText = "Error"; return; }
        let result = Math.sqrt(num);
        inputLine.innerText = "âˆš" + num;
        addHistory(inputLine.innerText + " = " + result);
        resultLine.innerText = result;
      } catch {
        resultLine.innerText = "Error";
      }
    }

    function addHistory(entry) {
      let div = document.createElement("div");
      div.className = "history-entry";
      let safe = entry.replace(/'/g, "\\'");
      div.innerHTML = `<span>${entry}</span>
        <button class="copy-btn" onclick="copyText('${safe}')">ðŸ“‹</button>`;
      historyDiv.prepend(div);
    }

    function clearHistory() {
      historyDiv.innerHTML = "";
    }

    function copyText(text) {
      if (!navigator.clipboard) { alert("Clipboard API not supported"); return; }
      navigator.clipboard.writeText(text);
      alert("Copied: " + text);
    }

    /* ================= Age Calculator functions ================= */

    function toggleAgePanel() {
      agePanel.classList.toggle("show");
      // if showing ensure extras also visible
      if (agePanel.classList.contains("show") && !extraDiv.classList.contains("show")) {
        extraDiv.classList.add("show");
        moreBtn.innerText = "Less";
      }
    }
    function hideAgePanel() {
      agePanel.classList.remove("show");
    }
    function fillToday(id) {
      const d = new Date();
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      document.getElementById(id).value = dd + mm + yyyy;
    }

    function parseDDMMYYYY(str) {
      if (!/^\d{8}$/.test(str)) return null;
      const d = parseInt(str.slice(0,2),10);
      const m = parseInt(str.slice(2,4),10);
      const y = parseInt(str.slice(4,8),10);
      // basic ranges
      if (y < 1000 || y > 9999) return null;
      if (m < 1 || m > 12) return null;
      const dt = new Date(y, m-1, d);
      // validate month/day correctness
      if (dt.getFullYear() !== y || dt.getMonth() !== (m-1) || dt.getDate() !== d) return null;
      return dt;
    }

    function diffDates(d1, d2) {
      // ensure d1 <= d2
      if (d1 > d2) { const tmp = d1; d1 = d2; d2 = tmp; }
      let y1 = d1.getFullYear(), m1 = d1.getMonth(), day1 = d1.getDate();
      let y2 = d2.getFullYear(), m2 = d2.getMonth(), day2 = d2.getDate();

      let years = y2 - y1;
      let months = m2 - m1;
      let days = day2 - day1;

      if (days < 0) {
        // borrow days from previous month of d2
        const prevMonth = new Date(y2, m2, 0); // day 0 of month gives last day previous month
        days += prevMonth.getDate();
        months -= 1;
      }
      if (months < 0) {
        months += 12;
        years -= 1;
      }
      return { years, months, days };
    }

    function calcAgeFromInputs() {
      const s1 = document.getElementById('date1').value.trim();
      const s2 = document.getElementById('date2').value.trim();
      if (!s1 || !s2) {
        alert('Please enter both dates in DDMMYYYY format.');
        return;
      }
      const d1 = parseDDMMYYYY(s1);
      const d2 = parseDDMMYYYY(s2);
      if (!d1 || !d2) {
        alert('Invalid date format or invalid date. Use DDMMYYYY (e.g. 05041990).');
        return;
      }
      const diff = diffDates(d1, d2);
      const resultText = `Difference: ${diff.years} years, ${diff.months} months, ${diff.days} days`;
      resultLine.innerText = resultText;
      inputLine.innerText = `${s1} â†” ${s2}`;
      addHistory(`${formatDate(d1)} â†” ${formatDate(d2)} = ${resultText}`);
      // close panel optionally (comment/uncomment next line as desired)
      // hideAgePanel();
    }

    function formatDate(d) {
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}-${mm}-${yy}`;
    }

    function hideAgePanel() {
      agePanel.classList.remove("show");
    }

  </script>
</body>
</html>
